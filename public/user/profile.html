// --- 1. GET ALL UNIVERSITIES (For Dropdown) ---
app.get('/api/universities', async (req, res) => {
    try {
        const [rows] = await pool.query("SELECT university_id, name FROM universities ORDER BY name ASC");
        res.json(rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "DB Error" });
    }
});

// --- 2. GET USER PROFILE ---
app.get('/api/user/profile', isAuthenticated, async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT user_id, email, name, picture, role, university_id, 
                   budget_min, budget_max, preferred_types, preferred_activities 
            FROM users WHERE user_id = ?`, [req.session.user.id]);
            
        if (rows.length === 0) return res.status(404).json({ error: "User not found" });
        res.json(rows[0]);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Server Error" });
    }
});

// --- 3. UPDATE PROFILE ---
app.put('/api/user/profile', isAuthenticated, async (req, res) => {
    const { name, role, university_id, budget_min, budget_max, preferred_types, preferred_activities, password } = req.body;
    const userId = req.session.user.id;

    let passwordSql = "";
    // Prepare preferences as JSON strings
    let params = [
        name, 
        role, 
        (role === 'student' ? university_id : null), // Only save Uni ID if role is student
        budget_min, 
        budget_max, 
        JSON.stringify(preferred_types),     
        JSON.stringify(preferred_activities) 
    ];

    if (password) {
        // Password Rule: 8+ chars, 1 number, 1 special char
        const passwordRegex = /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/;
        if (!passwordRegex.test(password)) {
            return res.status(400).json({ error: "Password must be 8+ chars, with a number & symbol." });
        }
        const hashedPassword = await bcrypt.hash(password, 10);
        passwordSql = ", password = ?";
        params.push(hashedPassword);
    }

    params.push(userId); // For WHERE clause

    try {
        const sql = `UPDATE users SET name=?, role=?, university_id=?, budget_min=?, budget_max=?, preferred_types=?, preferred_activities=? ${passwordSql} WHERE user_id=?`;
        await pool.query(sql, params);
        
        // Update Session to reflect new name/role immediately
        req.session.user.name = name;
        if(role) req.session.user.role = role;

        res.json({ message: "Profile updated successfully" });
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Update failed" });
    }
});

// --- 4. CALENDAR DATA (The Smart Logic) ---
app.get('/api/user/calendar', isAuthenticated, async (req, res) => {
    const userId = req.session.user.id;
    let events = [];

    try {
        // A. Fetch Personal Busy Dates (From user_availability)
        const [personalRows] = await pool.query("SELECT start_date, end_date, note FROM user_availability WHERE user_id = ?", [userId]);
        
        events = events.concat(personalRows.map(r => ({
            title: r.note || "Busy",
            start: r.start_date,
            end: r.end_date, 
            color: "#7f8c8d", // Grey for personal
            display: 'background'
        })));

        // B. Fetch University Events (If user is a student)
        const [userRows] = await pool.query("SELECT university_id FROM users WHERE user_id = ?", [userId]);
        const uniId = userRows[0]?.university_id;

        if (uniId) {
            // Join with university_schedules to get semester dates
            const [uniRows] = await pool.query("SELECT event_name, start_date, end_date, type FROM university_schedules WHERE university_id = ?", [uniId]);
            
            events = events.concat(uniRows.map(r => ({
                title: r.event_name,
                start: r.start_date,
                end: r.end_date,
                // Green for breaks, Red for exams
                color: r.type === 'semester_break' ? "#2ecc71" : "#e74c3c" 
            })));
        }

        res.json(events);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Calendar Error" });
    }
});

// --- 5. TOGGLE PERSONAL AVAILABILITY ---
app.post('/api/user/calendar/toggle', isAuthenticated, async (req, res) => {
    const { date } = req.body; 
    const userId = req.session.user.id;

    try {
        // Check if date is already blocked
        const [existing] = await pool.query("SELECT avail_id FROM user_availability WHERE user_id=? AND start_date=?", [userId, date]);

        if (existing.length > 0) {
            // Unblock: Delete row
            await pool.query("DELETE FROM user_availability WHERE avail_id=?", [existing[0].avail_id]);
            res.json({ status: "free" });
        } else {
            // Block: Insert row
            await pool.query("INSERT INTO user_availability (user_id, start_date, end_date, note) VALUES (?, ?, ?, ?)", 
                [userId, date, date, 'Personal Busy']);
            res.json({ status: "busy" });
        }
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Toggle Error" });
    }
});